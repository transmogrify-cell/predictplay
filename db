CREATE DATABASE PredictPlay;
USE PredictPlay;

CREATE TABLE users (
    user_id INT AUTO_INCREMENT PRIMARY KEY,
    full_name VARCHAR(100) NOT NULL,
    email VARCHAR(120) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role ENUM('user','admin') DEFAULT 'user',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE wallet (
    wallet_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT UNIQUE NOT NULL,
    balance DECIMAL(12,2) DEFAULT 0 CHECK(balance >= 0),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);

CREATE TABLE sports (
    sport_id INT AUTO_INCREMENT PRIMARY KEY,
    sport_name VARCHAR(50) NOT NULL UNIQUE
);

CREATE TABLE teams (
    team_id INT AUTO_INCREMENT PRIMARY KEY,
    team_name VARCHAR(100) NOT NULL UNIQUE
);

CREATE TABLE games (
    game_id INT AUTO_INCREMENT PRIMARY KEY,
    sport_id INT NOT NULL,
    team1_id INT NOT NULL,
    team2_id INT NOT NULL,
    game_time DATETIME NOT NULL,
    status ENUM('scheduled','live','finished','cancelled') DEFAULT 'scheduled',
    FOREIGN KEY (sport_id) REFERENCES sports(sport_id),
    FOREIGN KEY (team1_id) REFERENCES teams(team_id),
    FOREIGN KEY (team2_id) REFERENCES teams(team_id)
);

CREATE TABLE selections (
    selection_id INT AUTO_INCREMENT PRIMARY KEY,
    game_id INT NOT NULL,
    selection_name VARCHAR(120) NOT NULL,
    odds DECIMAL(6,2) NOT NULL CHECK (odds > 1),
    FOREIGN KEY (game_id) REFERENCES games(game_id) ON DELETE CASCADE
);

CREATE TABLE bets (
    bet_id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    total_amount DECIMAL(12,2) NOT NULL CHECK(total_amount > 0),
    status ENUM('placed','won','lost','cancelled') DEFAULT 'placed',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
);

CREATE TABLE bet_items (
    betitem_id INT AUTO_INCREMENT PRIMARY KEY,
    bet_id INT NOT NULL,
    selection_id INT NOT NULL,
    stake DECIMAL(12,2) NOT NULL CHECK (stake > 0),
    FOREIGN KEY (bet_id) REFERENCES bets(bet_id) ON DELETE CASCADE,
    FOREIGN KEY (selection_id) REFERENCES selections(selection_id) ON DELETE CASCADE
);

CREATE TABLE transactions (
    tx_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    tx_type ENUM('deposit','withdraw','bet_place','bet_payout') NOT NULL,
    amount DECIMAL(12,2) NOT NULL CHECK (amount > 0),
    reference_id INT NULL,
    tx_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);

CREATE TABLE audit_log (
    audit_id BIGINT AUTO_INCREMENT PRIMARY KEY,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TRIGGER trg_create_wallet
AFTER INSERT ON users
FOR EACH ROW
INSERT INTO wallet (user_id, balance)
VALUES (NEW.user_id, 0);


DELIMITER $$

CREATE TRIGGER trg_bet_place
AFTER INSERT ON bets
FOR EACH ROW
BEGIN
  -- Deduct amount from user wallet
  UPDATE wallet 
  SET balance = balance - NEW.total_amount
  WHERE user_id = NEW.user_id;

  -- Insert transaction record
  INSERT INTO transactions (user_id, tx_type, amount, reference_id)
  VALUES (NEW.user_id, 'bet_place', NEW.total_amount, NEW.bet_id);

  -- Add to audit log
  INSERT INTO audit_log (description)
  VALUES (CONCAT('User ', NEW.user_id, ' placed a bet of ', NEW.total_amount));
END$$


DELIMITER $$

CREATE TRIGGER trg_deposit
AFTER INSERT ON transactions
FOR EACH ROW
BEGIN
  IF NEW.tx_type = 'deposit' THEN
    UPDATE wallet 
    SET balance = balance + NEW.amount
    WHERE user_id = NEW.user_id;

    INSERT INTO audit_log (description)
    VALUES (CONCAT('Deposit of ', NEW.amount, ' by user ', NEW.user_id));
  END IF;
END$$

DELIMITER ;


DELIMITER $$

CREATE TRIGGER trg_withdraw
BEFORE INSERT ON transactions
FOR EACH ROW
BEGIN
    DECLARE bal DECIMAL(12,2);

    IF NEW.tx_type = 'withdraw' THEN
        
        -- Fetch current balance
        SELECT balance INTO bal 
        FROM wallet 
        WHERE user_id = NEW.user_id;

        -- Check if enough balance exists
        IF bal < NEW.amount THEN
            SIGNAL SQLSTATE '45000' 
                SET MESSAGE_TEXT = 'Insufficient balance for withdrawal';
        END IF;

        -- Deduct amount from wallet
        UPDATE wallet 
        SET balance = balance - NEW.amount
        WHERE user_id = NEW.user_id;

        -- Log the action
        INSERT INTO audit_log (description)
        VALUES (CONCAT('Withdrawal of ', NEW.amount, ' by user ', NEW.user_id));

    END IF;
END$$

DELIMITER ;

DELIMITER $$

CREATE TRIGGER trg_bet_payout
AFTER UPDATE ON bets
FOR EACH ROW
BEGIN
    IF NEW.status = 'won' THEN

        -- Add winnings to user's wallet
        UPDATE wallet 
        SET balance = balance + NEW.total_amount
        WHERE user_id = NEW.user_id;

        -- Create a payout transaction
        INSERT INTO transactions (user_id, tx_type, amount, reference_id)
        VALUES (NEW.user_id, 'bet_payout', NEW.total_amount, NEW.bet_id);

        -- Add audit log entry
        INSERT INTO audit_log (description)
        VALUES (CONCAT('Bet payout: ', NEW.total_amount, ' to user ', NEW.user_id));

    END IF;
END$$

DELIMITER ;